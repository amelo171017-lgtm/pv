<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
    />
    <title>CO₂trola</title>

    <link rel="icon" type="image/png" href="./icon.png" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="./styles.css" />
    <meta name="theme-color" content="#00d4aa" />
    <link rel="manifest" href="./manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="CO₂trola" />
    <link rel="apple-touch-icon" href="./icon.png" />
  </head>
  <body>
    <div class="desktop-blocker" aria-hidden="true">
      <p>
        Este app foi feito apenas para celular. Acesse em um dispositivo móvel.
      </p>
    </div>

    <main id="app" class="container" role="application">
      <header class="hero" role="banner">
        <img class="app-icon" src="./icon.png" alt="Ícone do CO₂trola" />
        <h1 class="logo" aria-label="CO2trola">
          CO<span class="sub">2</span>trola
        </h1>
        <p class="tag">
          A qualidade do ar em ambientes fechados pode ser estimada pelo
          microfone do seu celular usando uma tecnologia única.
        </p>
      </header>

      <section class="indices" aria-labelledby="indices-title">
        <h2 id="indices-title" class="sr-only">Índices de qualidade do ar</h2>
        <ul class="index-list">
          <li data-color="#00d4aa">
            <span class="dot" style="--c: #00d4aa"></span
            ><strong>Excelente</strong> — ambiente muito saudável
          </li>
          <li data-color="#2ecc71">
            <span class="dot" style="--c: #2ecc71"></span><strong>Boa</strong> —
            adequado para permanência
          </li>
          <li data-color="#f1c40f">
            <span class="dot" style="--c: #f1c40f"></span
            ><strong>Moderada</strong> — atenção a ventilação
          </li>
          <li data-color="#e67e22">
            <span class="dot" style="--c: #e67e22"></span
            ><strong>Ruim</strong> — ventilar e reduzir fontes
          </li>
          <li data-color="#e74c3c">
            <span class="dot" style="--c: #e74c3c"></span
            ><strong>Muito ruim</strong> — agir imediatamente
          </li>
        </ul>
      </section>

      <section class="content" role="region" aria-labelledby="cta-title">
        <h2 id="cta-title" class="sr-only">Medir</h2>
        <button id="btn-open-modal" class="cta" type="button">
          Medir agora
        </button>
      </section>

      <section id="measuring" class="measuring hidden" aria-live="polite">
        <div class="progress-wrap">
          <div class="progress-bar"><span class="progress"></span></div>
          <p id="measure-status" class="measure-status">Preparando…</p>
        </div>
      </section>

      <section id="result" class="result hidden" aria-live="polite">
        <div class="result-card">
          <p class="result-label">Índice estimado</p>
          <p id="result-title" class="result-title">—</p>
          <ul id="result-tips" class="tips"></ul>
          <button id="btn-new" class="link">Nova medição</button>
        </div>
      </section>

      <footer class="foot" role="contentinfo">
        <small>© <span id="year"></span> CO₂trola</small>
      </footer>
    </main>

    <div
      id="modal"
      class="modal hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title"
    >
      <div class="modal__box">
        <h3 id="modal-title">Medição de qualidade do ar</h3>
        <p>
          A medição dura entre <strong>30s</strong> e <strong>1min30s</strong>.
          Mantenha o celular parado, evite falar e permaneça no ambiente a ser
          analisado. Resultados são estimativas e não substituem instrumentos
          profissionais.
        </p>
        <div class="modal__actions">
          <button id="btn-cancel" class="btn-secondary" type="button">
            Cancelar
          </button>
          <button id="btn-start" class="btn-primary" type="button">
            Medir
          </button>
        </div>
      </div>
    </div>

    <script>
      (function () {
        var y = document.getElementById("year");
        if (y) y.textContent = new Date().getFullYear();
      })();

      var modal = document.getElementById("modal");
      var openBtn = document.getElementById("btn-open-modal");
      var cancelBtn = document.getElementById("btn-cancel");
      var startBtn = document.getElementById("btn-start");
      var measuring = document.getElementById("measuring");
      var result = document.getElementById("result");
      var resultTitle = document.getElementById("result-title");
      var resultTips = document.getElementById("result-tips");
      var statusEl = document.getElementById("measure-status");
      var progressEl = document.querySelector(".progress");
      var newBtn = document.getElementById("btn-new");

      var indexCatalog = [
        {
          name: "Excelente",
          color: "#00d4aa",
          tips: [
            "Mantenha ventilação natural.",
            "Plantas saudáveis ajudam no conforto.",
            "Evite fontes de fumaça.",
          ],
        },
        {
          name: "Boa",
          color: "#2ecc71",
          tips: [
            "Abra janelas periodicamente.",
            "Hidrate-se bem.",
            "Limpeza leve e regular.",
          ],
        },
        {
          name: "Moderada",
          color: "#f1c40f",
          tips: [
            "Aumente a ventilação.",
            "Evite produtos com odor forte.",
            "Reduza aglomeração no ambiente.",
          ],
        },
        {
          name: "Ruim",
          color: "#e67e22",
          tips: [
            "Ventile imediatamente.",
            "Use exaustores/ventiladores.",
            "Interrompa fontes de poluição (fumaça, produtos químicos).",
          ],
        },
        {
          name: "Muito ruim",
          color: "#e74c3c",
          tips: [
            "Saia do local se possível.",
            "Aumente drasticamente a renovação de ar.",
            "Considere purificador com filtro HEPA.",
          ],
        },
      ];

      function openModal() {
        modal.classList.remove("hidden");
      }
      function closeModal() {
        modal.classList.add("hidden");
      }

      function resetUI() {
        measuring.classList.add("hidden");
        result.classList.add("hidden");
        statusEl.textContent = "Preparando…";
        progressEl.style.width = "0%";
      }

      function startMeasurement() {
        closeModal();
        resetUI();
        measuring.classList.remove("hidden");

        var totalMs = Math.floor(30000 + Math.random() * 60000);
        var start = Date.now();
        function gerarEtapasAleatorias() {
          const etapasPossiveis = [
            "Consultando padrões da OMS…",
            "Verificando sensores do dispositivo…",
            "Captando áudio ambiente…",
            "Filtrando ruídos externos…",
            "Analisando espectros do ambiente…",
            "Detectando variações de frequência…",
            "Estimando compostos gasosos por cm³…",
            "Comparando com padrões nacionais…",
            "Gerando índice de qualidade…",
            "Finalizando análise…",
            "Ajustando parâmetros de sensibilidade…",
            "Sincronizando com banco de dados…",
            "Avaliando ruído de fundo…",
            "Checando integridade dos dados…",
            "Avaliando temperatura ambiente…",
            "Verificando umidade relativa…",
            "Processando sinais captados…",
            "Ajustando algoritmos de detecção…",
            "Validando resultados preliminares…",
            "Otimizando análise espectral…",
          ];

          function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
          }

          const quantidade = Math.floor(Math.random() * 5) + 8;
          const primeira = "Consultando padrões da OMS…";
          const ultima = "Finalizando análise…";
          const restantes = etapasPossiveis.filter(
            (e) => e !== primeira && e !== ultima
          );
          const intermediarias = shuffle(restantes).slice(0, quantidade - 2);
          return [primeira, ...intermediarias, ultima];
        }

        var steps = gerarEtapasAleatorias();
        var stepIndex = 0;

        var ticker = setInterval(function () {
          var elapsed = Date.now() - start;
          var pct = Math.min(1, elapsed / totalMs);
          progressEl.style.width = (pct * 100).toFixed(1) + "%";

          var nextThreshold = (stepIndex + 1) / steps.length;
          if (pct >= nextThreshold && stepIndex < steps.length - 1) {
            stepIndex++;
            statusEl.textContent = steps[stepIndex];
          }

          if (pct >= 1) {
            clearInterval(ticker);
            showResult();
          }
        }, 100);

        statusEl.textContent = steps[0];
      }

      function showResult() {
        measuring.classList.add("hidden");
        result.classList.remove("hidden");

        var item =
          indexCatalog[Math.floor(Math.random() * indexCatalog.length)];
        resultTitle.textContent = item.name;
        resultTitle.style.setProperty("--result-color", item.color);

        resultTips.innerHTML = "";
        item.tips.forEach(function (t) {
          var li = document.createElement("li");
          li.textContent = t;
          resultTips.appendChild(li);
        });
      }

      openBtn.addEventListener("click", openModal);
      cancelBtn.addEventListener("click", closeModal);
      startBtn.addEventListener("click", startMeasurement);
      newBtn.addEventListener("click", function () {
        resetUI();
      });

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker
            .register("./sw.js")
            .then(function (registration) {
              console.log(
                "Service Worker registrado com sucesso:",
                registration.scope
              );
            })
            .catch(function (error) {
              console.log("Falha no registro do Service Worker:", error);
            });
        });
      }
    </script>
  </body>
</html>
